#include "Player.h"
#include "Engine/Editer/Window/EditerWindows.h"
#include "Game/GameObject/Player/State/PlayerDefaultState.h"
#include "Game/GameObject/Player/State/PlayerMoveState.h"

Player::Player() {}
Player::~Player() {}

void Player::Finalize() {
}

//////////////////////////////////////////////////////////////////////////////////////////////////
// ↓　初期化処理
//////////////////////////////////////////////////////////////////////////////////////////////////

void Player::Init() {
	BaseGameObject::Init();
	SetObject("player.obj");

	behaviorRequest_ = Behavior::DEFAULT;
	CheckBehaviorRequest();

	isJump_ = false;

#ifdef _DEBUG
	EditerWindows::AddObjectWindow(std::bind(&Player::Debug_Gui, this), "player");
#endif
}

//////////////////////////////////////////////////////////////////////////////////////////////////
// ↓　更新処理
//////////////////////////////////////////////////////////////////////////////////////////////////

void Player::Update() {
	CheckMove();

	CheckBehaviorRequest();
	state_->Update();

	BaseGameObject::Update();
}

//////////////////////////////////////////////////////////////////////////////////////////////////
// ↓　描画処理
//////////////////////////////////////////////////////////////////////////////////////////////////

void Player::Draw() const {
	BaseGameObject::Draw();
}

//////////////////////////////////////////////////////////////////////////////////////////////////
// ↓　状態遷移
//////////////////////////////////////////////////////////////////////////////////////////////////

void Player::CheckBehaviorRequest() {
	if (behaviorRequest_) {
		behavior_ = behaviorRequest_.value();

		switch (behavior_) {
		case Behavior::DEFAULT:
			SetBehaviorState(std::make_unique<PlayerDefaultState>(this));
			break;
		case Behavior::MOVE:
			SetBehaviorState(std::make_unique<PlayerMoveState>(this));
			break;
		default:
			break;
		}
		// 振る舞いをリセット
		behaviorRequest_ = std::nullopt;
	}
}

//////////////////////////////////////////////////////////////////////////////////////////////////
// ↓　移動状態受付
//////////////////////////////////////////////////////////////////////////////////////////////////

void Player::CheckMove() {
	if (Input::GetLeftJoyStick().x != 0.0f || Input::GetLeftJoyStick().y != 0.0f) {
		behaviorRequest_ = Behavior::MOVE;
	}

	if (Input::IsTriggerKey(DIK_SPACE) || Input::GetIsPadTrigger(BUTTON_A)) {
		behaviorRequest_ = Behavior::MOVE;
		isJump_ = true;
	}
}

//////////////////////////////////////////////////////////////////////////////////////////////////
// ↓　編集処理
//////////////////////////////////////////////////////////////////////////////////////////////////
#ifdef _DEBUG
void Player::Debug_Gui() {
	BaseGameObject::Debug_Gui();
	state_->Debug_Gui();
}
#endif